# Ticketr in Next.js 15.0.3

> This project get from [Sonny Sangha](https://www.youtube.com/@SonnySangha) YouTube channel

> Project Link [Lets build a Ticket Marketplace SAAS with NEXT.JS 15 (Convex, Stripe Connect, Clerk, Tailwind, TS)](https://www.youtube.com/watch?v=KdYci4gA2os)

## Clerk (Authentication)

- [Clerk](https://clerk.com/) is a platform for building and managing user accounts and authentication.

- Wrap your app in a ClerkProvider component to enable authentication and authorization.

```typescript
import type { Metadata } from "next";
import localFont from "next/font/local";
import "./globals.css";
import { ClerkProvider } from "@clerk/nextjs";

const geistSans = localFont({
  src: "./fonts/GeistVF.woff",
  variable: "--font-geist-sans",
  weight: "100 900",
});
const geistMono = localFont({
  src: "./fonts/GeistMonoVF.woff",
  variable: "--font-geist-mono",
  weight: "100 900",
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        <ClerkProvider>{children}</ClerkProvider>
      </body>
    </html>
  );
}

```

- you can control routers using default middleware.

```typescript
import { clerkMiddleware } from "@clerk/nextjs/server";

export default clerkMiddleware();

export const config = {
  matcher: [
    // Skip Next.js internals and all static files, unless found in search params
    "/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)",
    // Always run for API routes
    "/(api|trpc)(.*)",
  ],
};
```

## Convex (Backend)

- [Convex](https://www.convex.dev/) is the sync platform that replaces your backend and client state management.
- just follow the step for add to [next.js project](https://docs.convex.dev/quickstart/nextjs).
- run the project `npx convex dev`.
- copy `sampleData.json` to `convex/sampleData.json` (this for seed data)
- run the convert import data command
- the storage of convex give a new url for upload files in every time this is a more secure way for expose backend data.

- If you want to connect convex with Clerk follow the [guide](https://docs.convex.dev/auth/clerk)

## Stripe Connect

- [Stripe Connect](https://stripe.com/connect) is a service that allows you to accept payments from your customers using Stripe's payment processing platform.
- select the `seller will collect payments directly`.
- select the industry `Ticketing or Events`(what ever you want).
- select the create their account `Onboarding hosted by Stripe`.
- select the seller manage their account `Stripe Dashboard`.
- Review and continue.

- install the npm `npm install --save stripe` in your project.
- Copy the stripe `STRIPE_SECRET_KEY` and `STRIPE_PUBLISHABLE_KEY` from your Stripe dashboard.

- Create a function for seller want to accept payments requirements.

```typescript
export async function getStripeConnectAccountStatus(
  stripeAccountId: string
): Promise<AccountStatus> {
  if (!stripeAccountId) {
    throw new Error("No Stripe account ID provided");
  }

  try {
    const account = await stripe.accounts.retrieve(stripeAccountId);

    return {
      isActive:
        account.details_submitted &&
        !account.requirements?.currently_due?.length,
      requiresInformation: !!(
        account.requirements?.currently_due?.length ||
        account.requirements?.eventually_due?.length ||
        account.requirements?.past_due?.length
      ),
      requirements: {
        currently_due: account.requirements?.currently_due || [],
        eventually_due: account.requirements?.eventually_due || [],
        past_due: account.requirements?.past_due || [],
      },
      chargesEnabled: account.charges_enabled,
      payoutsEnabled: account.payouts_enabled,
    };
  } catch (error) {
    console.error("Error fetching Stripe Connect account status:", error);
    throw new Error("Failed to fetch Stripe Connect account status");
  }
}
```

- Add function for connect stripe to seller account.

```typescript
"use server";

import { stripe } from "@/lib/stripe";
import { headers } from "next/headers";

export async function createStripeConnectAccountLink(account: string) {
  try {
    const headersList = await headers();
    const origin = headersList.get("origin") || "";

    const accountLink = await stripe.accountLinks.create({
      account,
      refresh_url: `${origin}/connect/refresh/${account}`,
      return_url: `${origin}/connect/return/${account}`,
      type: "account_onboarding",
    });

    return { url: accountLink.url };
  } catch (error) {
    console.error(
      "An error occurred when calling the Stripe API to create an account link:",
      error
    );
    if (error instanceof Error) {
      throw new Error(error.message);
    }
    throw new Error("An unknown error occurred");
  }
}
```

- Create a function to access seller go to stripe dashboard for their payment history.

```typescript
"use server";

import { stripe } from "@/lib/stripe";

export async function createStripeConnectLoginLink(stripeAccountId: string) {
  if (!stripeAccountId) {
    throw new Error("No Stripe account ID provided");
  }

  try {
    const loginLink = await stripe.accounts.createLoginLink(stripeAccountId);
    return loginLink.url;
  } catch (error) {
    console.error("Error creating Stripe Connect login link:", error);
    throw new Error("Failed to create Stripe Connect login link");
  }
}
```

- Create a function for checkout session for buyer.

```typescript
"use server";

import { stripe } from "@/lib/stripe";

import { api } from "@/convex/_generated/api";
import { Id } from "@/convex/_generated/dataModel";

import { auth } from "@clerk/nextjs/server";
import { DURATIONS } from "@/convex/constants";
import baseUrl from "@/lib/baseUrl";
import { getConvexClient } from "@/lib/convex";

export type StripeCheckoutMetaData = {
  eventId: Id<"events">;
  userId: string;
  waitingListId: Id<"waitingList">;
};

export async function createStripeCheckoutSession({
  eventId,
}: {
  eventId: Id<"events">;
}) {
  const { userId } = await auth();
  if (!userId) throw new Error("Not authenticated");

  const convex = getConvexClient();

  // Get event details
  const event = await convex.query(api.events.getById, { eventId });
  if (!event) throw new Error("Event not found");

  // Get waiting list entry
  const queuePosition = await convex.query(api.waitingList.getQueuePosition, {
    eventId,
    userId,
  });

  if (!queuePosition || queuePosition.status !== "offered") {
    throw new Error("No valid ticket offer found");
  }

  const stripeConnectId = await convex.query(api.users.getUserStripeConnectId, {
    userId: event.userId,
  });

  if (!stripeConnectId) {
    throw new Error("Stripe Connect ID not found for owner of the event!");
  }

  if (!queuePosition.offerExpiresAt) {
    throw new Error("Ticket offer has no expiration date");
  }

  const metadata: StripeCheckoutMetaData = {
    eventId,
    userId,
    waitingListId: queuePosition._id,
  };

  // Create Stripe Checkout Session
  const session = await stripe.checkout.sessions.create(
    {
      payment_method_types: ["card"],

      line_items: [
        {
          price_data: {
            currency: "gbp",
            product_data: {
              name: event.name,
              description: event.description,
            },
            unit_amount: Math.round(event.price * 100),
          },
          quantity: 1,
        },
      ],
      payment_intent_data: {
        application_fee_amount: Math.round(event.price * 100 * 0.01),
      },
      expires_at: Math.floor(Date.now() / 1000) + DURATIONS.TICKET_OFFER / 1000, // 30 minutes (stripe checkout minimum expiration time)
      mode: "payment",
      success_url: `${baseUrl}/tickets/purchase-success?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: `${baseUrl}/event/${eventId}`,
      metadata,
    },
    {
      stripeAccount: stripeConnectId,
    }
  );

  return { sessionId: session.id, sessionUrl: session.url };
}
```

- Stripe connect [docs](https://docs.stripe.com/connect/onboarding/quickstart?connect-onboarding-surface=hosted&connect-dashboard-type=full&connect-economic-model=buy-rate&connect-loss-liability-owner=stripe&connect-charge-type=direct&client=next#init-stripe)

- add stripe webhook for checkout session status.

```typescript
import { headers } from "next/headers";
import { stripe } from "@/lib/stripe";
import { getConvexClient } from "@/lib/convex";
import { api } from "@/convex/_generated/api";
import Stripe from "stripe";
import { StripeCheckoutMetaData } from "@/actions/createStripeCheckoutSession";

export async function POST(req: Request) {
  console.log("Webhook received");

  const body = await req.text();
  const headersList = await headers();
  const signature = headersList.get("stripe-signature") as string;

  console.log("Webhook signature:", signature ? "Present" : "Missing");

  let event: Stripe.Event;

  try {
    console.log("Attempting to construct webhook event");
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    );
    console.log("Webhook event constructed successfully:", event.type);
  } catch (err) {
    console.error("Webhook construction failed:", err);
    return new Response(`Webhook Error: ${(err as Error).message}`, {
      status: 400,
    });
  }

  const convex = getConvexClient();

  if (event.type === "checkout.session.completed") {
    console.log("Processing checkout.session.completed");
    const session = event.data.object as Stripe.Checkout.Session;
    const metadata = session.metadata as StripeCheckoutMetaData;
    console.log("Session metadata:", metadata);
    console.log("Convex client:", convex);

    try {
      const result = await convex.mutation(api.events.purchaseTicket, {
        eventId: metadata.eventId,
        userId: metadata.userId,
        waitingListId: metadata.waitingListId,
        paymentInfo: {
          paymentIntentId: session.payment_intent as string,
          amount: session.amount_total ?? 0,
        },
      });
      console.log("Purchase ticket mutation completed:", result);
    } catch (error) {
      console.error("Error processing webhook:", error);
      return new Response("Error processing webhook", { status: 500 });
    }
  }

  return new Response(null, { status: 200 });
}
```

- Run this webhook in local use the doc in webhook add section in stripe.
- Install stripe cli
- run `stripe listen --forward-to localhost:3000/api/webhooks/stripe`
- then run stripe cli `stripe login`. you redirect to stripe dashboard.
- after verification get the webhook secret key for local in console and paste it in the `STRIPE_WEBHOOK_SECRET` variable. 
- for production run get the webhook secret in stripe dashboard and paste it in the `STRIPE_WEBHOOK_SECRET` variable.


## React Qr Code

- Create a QR code using the [react-qr-code](https://www.npmjs.com/package/react-qr-code) package.
- install the npm `npm install react-qr-code` in your project.

> Project [Github Link](https://github.com/sonnysangha/ticket-marketplace-saas-nextjs15-convex-clerk-stripe-connect)
> Thanks for [Sonny Sangha](https://www.youtube.com/@SonnySangha)
